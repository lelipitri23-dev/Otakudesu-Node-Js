<%- include('partials/header', { /* data header */ }) %>

<main class="flex-1 w-full min-w-0">
  <div class="bg-card rounded-lg shadow-md border border-[#33303f] overflow-hidden mb-6">
    
    <div class="flex items-center justify-between p-5 border-b border-[#33303f]">
      <h1 class="text-base md:text-lg font-bold text-[var(--text-main)] uppercase border-l-4 border-primary pl-3 leading-tight">
        Jadwal Rilis Anime (Simulcast)
      </h1>
      <span class="text-xs text-muted hidden sm:block">Sumber: Jikan API (MyAnimeList)</span>
    </div>

    <div class="px-5 pt-5">
      <div class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar" id="day-nav">
        </div>
    </div>

    <div class="p-5">
      <p class="text-center text-sm text-muted mb-6" id="status-text">
        Pilih hari untuk melihat jadwal rilis anime musim ini.
      </p>
      
      <div id="jadwal-loading" class="flex flex-col items-center justify-center py-12 text-muted">
        <svg class="animate-spin h-8 w-8 text-primary mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p>Sedang memuat data dari Jikan API...</p>
      </div>
      
      <div id="jadwal-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 hidden">
        </div>
    </div>
    
  </div>
</main>

<%- include('partials/sidebar', { page: page }) %>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const days = [
      { id: 'monday', label: 'Senin' },
      { id: 'tuesday', label: 'Selasa' },
      { id: 'wednesday', label: 'Rabu' },
      { id: 'thursday', label: 'Kamis' },
      { id: 'friday', label: 'Jumat' },
      { id: 'saturday', label: 'Sabtu' },
      { id: 'sunday', label: 'Minggu' }
    ];

    const navContainer = document.getElementById('day-nav');
    const gridContainer = document.getElementById('jadwal-grid');
    const loadingDiv = document.getElementById('jadwal-loading');
    const statusText = document.getElementById('status-text');

    const todayIndex = new Date().getDay(); 
    const jsDayToJikan = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const currentDayId = jsDayToJikan[todayIndex];

    days.forEach(day => {
      const btn = document.createElement('button');
      btn.className = `px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-colors border border-[#33303f] ${day.id === currentDayId ? 'bg-primary text-white border-primary' : 'bg-darker text-gray-400 hover:bg-primary hover:text-white'}`;
      btn.textContent = day.label;
      btn.dataset.day = day.id;
      btn.onclick = () => loadSchedule(day.id, btn);
      navContainer.appendChild(btn);
    });

    // Helper Translate Season
    function translateSeason(season) {
      if(!season) return '';
      const map = {
        'winter': 'Dingin',
        'spring': 'Semi',
        'summer': 'Panas',
        'fall': 'Gugur'
      };
      return map[season.toLowerCase()] || season;
    }

    async function loadSchedule(day, activeBtn) {
      Array.from(navContainer.children).forEach(b => {
        b.classList.remove('bg-primary', 'text-white', 'border-primary');
        b.classList.add('bg-darker', 'text-gray-400');
      });
      activeBtn.classList.remove('bg-darker', 'text-gray-400');
      activeBtn.classList.add('bg-primary', 'text-white', 'border-primary');

      gridContainer.classList.add('hidden');
      loadingDiv.classList.remove('hidden');
      statusText.textContent = `Menampilkan jadwal anime hari ${activeBtn.textContent}`;

      try {
        // Fetch jadwal hari ini & SFW
        const response = await fetch(`https://api.jikan.moe/v4/schedules?filter=${day}&sfw=true`);
        const data = await response.json();

        renderGrid(data.data || []);
      } catch (error) {
        console.error('Jikan API Error:', error);
        gridContainer.innerHTML = '<p class="col-span-full text-center text-red-500">Gagal memuat jadwal. Silakan coba lagi nanti.</p>';
      } finally {
        loadingDiv.classList.add('hidden');
        gridContainer.classList.remove('hidden');
      }
    }

    function renderGrid(animeList) {
      gridContainer.innerHTML = '';

      // [UPDATE] Filter Logic yang Lebih Ketat
      const filteredList = animeList.filter(anime => {
        // 1. Wajib ada gambar
        if(!anime.images || !anime.images.jpg || !anime.images.jpg.image_url) return false;
        
        // 2. Status harus 'Currently Airing'
        if(anime.status !== 'Currently Airing') return false;

        // 3. [BARU] Filter Season: Pastikan anime memiliki data Season & Tahun
        // Ini menyaring tayangan 're-run' atau tayangan abadi yang tidak masuk chart musiman
        if(!anime.season || !anime.year) return false;

        return true;
      });

      if (filteredList.length === 0) {
        gridContainer.innerHTML = '<p class="col-span-full text-center text-muted">Tidak ada jadwal anime musim ini untuk hari ini.</p>';
        return;
      }

      // Urutkan berdasarkan waktu tayang (opsional)
      // filteredList.sort((a, b) => (a.score > b.score) ? -1 : 1); // Sort by score example

      filteredList.forEach(anime => {
        const card = document.createElement('article');
        card.className = 'group relative bg-darker rounded-md overflow-hidden border border-[#33303f] hover:border-primary hover:-translate-y-1 transition-all duration-300 shadow-sm hover:shadow-lg';
        
        const searchUrl = `/search?q=${encodeURIComponent(anime.title)}`;
        const seasonText = `${translateSeason(anime.season)} ${anime.year}`;

        card.innerHTML = `
          <a href="${searchUrl}" title="${anime.title}">
            <div class="relative aspect-[2/3] overflow-hidden bg-gray-800">
              <img src="${anime.images.jpg.image_url}" 
                   class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 lazy-load" 
                   loading="lazy"
                   alt="${anime.title}">
              
              <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20">
                 <i class="fas fa-search text-3xl text-white"></i>
              </div>

              ${anime.score ? `
              <span class="absolute top-1 left-1 bg-black/70 text-white text-[9px] font-bold px-1.5 py-0.5 rounded z-10 flex items-center gap-1">
                <i class="fas fa-star text-yellow-500 text-[8px]"></i> ${anime.score}
              </span>` : ''}

              <span class="absolute top-1 right-1 bg-primary text-white text-[8px] font-bold px-1.5 py-0.5 rounded z-10 shadow uppercase">
                ${seasonText}
              </span>

              <span class="absolute bottom-0 right-0 bg-primary text-white text-[9px] font-bold px-2 py-0.5 rounded-tl z-10 backdrop-blur-sm">
                ${anime.type || 'TV'}
              </span>
            </div>
            
            <div class="p-3 flex flex-col h-[80px] justify-between">
              <h2 class="text-xs sm:text-sm font-semibold text-[var(--text-main)] line-clamp-2 leading-snug group-hover:text-primary transition-colors">
                ${anime.title}
              </h2>
              <div class="flex justify-between items-end text-[10px] text-muted mt-1 border-t border-white/5 pt-1">
                <span>${anime.broadcast.time || 'N/A'}</span>
                <span class="text-green-400 font-bold text-[9px] border border-green-400 px-1 rounded">ON AIR</span>
              </div>
            </div>
          </a>
        `;
        gridContainer.appendChild(card);
      });
    }

    const initialBtn = navContainer.querySelector(`button[data-day="${currentDayId}"]`);
    if(initialBtn) {
        initialBtn.click();
    } else {
        navContainer.querySelector('button').click(); 
    }
  });
</script>

<%- include('partials/footer', { page: page }) %>
